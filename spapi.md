## selling partner api (spapi) with node

required libs: 

aws4 = require('aws4'), xml2js = require('xml2js'), _ = require('lodash')

### get orders
1. get accessToken => 'x-amz-access-token'
2. get temporary credentials => 'Authorization', 'X-Amz-Security-Token'
3. get orders

#### get access token
access token expires in 1 hour
```
async function getToken() {
  let localToken = accessToken;
  if (localToken && localToken.data && localToken.expiresAt && new Date().getTime() < Number(localToken.expiresAt)) {
    return {
      result: localToken.data
    };
  } else {
    let url = 'https://api.amazon.com/auth/o2/token';
    let body = new URLSearchParams();
    body.append("grant_type", "refresh_token");
    body.append("client_id", clientID);
    body.append("refresh_token", refreshToken);
    body.append("client_secret", clientSecret);
    let response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: body
    })
    if (response) {
      if (response.ok) {
        response = await response.json();
        let localStorage = {
          expiresAt: new Date().getTime() + _.get(response, 'expires_in') ? Number(_.get(response, 'expires_in')) * 1000 : 1000 * 60 * 60 * 59,
          data: response.access_token
        }
        accessToken = localStorage;
        return {
          result: response.access_token
        };
      } else {
        accessToken = null;
        return {
          message: response.statusText
        }
      }
    } else {
      return {
        message: 'No response from spapi'
      }
    }
  }
}
```
#### get credentials
credentials return their expiration time. Use aws4 to generate Authorization. Use xml2js to transform the xml response into object.  
accessKeyId and secretAccessKey, and roleArn should share the same user.  
request generated by aws4 is can be directly used for https.request. If so, there is no need to keep the url. url = `https://${signedRequest.host}${signedRequest.path}`

```
async function getCredentials() {
  let localToken = credentials;
  if (localToken && localToken.SessionToken && localToken.Expiration && new Date() < new Date(localToken.Expiration)) {
    return localToken;
  } else {
    let url = `https://sts.amazonaws.com/?Version=2011-06-15&Action=AssumeRole&RoleSessionName=Test&RoleArn=${roleArn}&DurationSeconds=3600`;
    const params = {
      path: `/?Version=2011-06-15&Action=AssumeRole&RoleSessionName=Test&RoleArn=${roleArn}&DurationSeconds=3600`,
      method: 'GET',
      host: 'sts.amazonaws.com',
      region: region,
      service: 'sts',
    };
  
    let request = aws4.sign(params, {
      accessKeyId: accessKeyId,
      secretAccessKey: secretAccessKey,
      region: region
    });
    let resp = await fetch(url, request);
    if(resp && resp.ok){
      resp = await resp.text();
      resp = await xml2js.parseStringPromise(resp, {
        explicitArray: false
      });
      localToken = _.get(resp,'AssumeRoleResponse.AssumeRoleResult.Credentials');
      if(localToken){
        credentials = localToken;
        return localToken
      }else{
        return {message: "Cannot get credentials"}
      }
    }else{
      credentials = null;
      return {
        message: resp.statusText
      }
    }
  }
};
```
#### get orders
Please notice that the accessKeyId, secretAccessKey, and sessionToken here all come from getCredentials (different from the id on user page).

```
async function requestConfig(path) {
  let tempCreds = await getCredentials();
  if (tempCreds.message) {
    return {
      message: tempCreds.message
    }
  }
  const {
    AccessKeyId,
    SessionToken,
    SecretAccessKey,
  } = tempCreds;
  const host = amzUrl.substring(amzUrl.indexOf('://') + 3);
  let token = await getToken();
  if (token.result) {
    token = token.result;
  } else {
    return {
      message: token.message
    }
  }
  const params = {
    path: path,
    method: 'GET',
    host: host,
    region: region,
    service: 'execute-api',
    headers: {
      'User-Agent': 'MyAmazonApp/1.0 (Language=JavaScript;)',
      'x-amz-access-token': token,
    },
  };

  return aws4.sign(params, {
    accessKeyId: AccessKeyId,
    secretAccessKey: SecretAccessKey,
    sessionToken: SessionToken,
    region: region
  });
}
async function getOrders(){
  let now = new Date();
  let oneWeekAgo = new Date(now.getTime()-1000*60*60*24*7).toISOString();
  let signedRequest = await requestConfig(`/orders/v0/orders?MarketplaceIds=${marketplaceId}&CreatedAfter=${oneWeekAgo}`);
  console.log(signedRequest);
  let response = await fetch(`https://${signedRequest.host}${signedRequest.path}`,signedRequest);
  if(response){
    response = await response.json();
    if(response.errors){
      return {
        message: response.errors.map(el=>el.message).join('. '),
        errors: response.errors
      }
    }else if(response.payload && response.payload.Orders){
      return response.payload.Orders;
    }else {
      return {
        message: 'Cannot get orders from amz',
        errors: response
      }
    }
  }else{
    return {
      message: 'No response from orders'
    }
  }
}
```
